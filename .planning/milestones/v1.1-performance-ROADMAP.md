# v1.1 Performance Overhaul Milestone

**Priority:** CRITICAL - Blocks App Store Submission
**Created:** 2026-01-21
**Goal:** Achieve <200ms highlighting for any file up to 5000 lines

## Problem Statement

Current state: 50KB/1940-line Info.plist takes 15+ seconds to highlight.
Expected state: Should complete in <200ms based on Highlightr benchmarks (50ms/500 lines on iPhone 6s).

**Root Causes Identified:**
1. In-memory cache lost when QuickLook XPC service terminates
2. FastSyntaxHighlighter runs multiple regex passes over entire string
3. AttributedString mutation is expensive for large files
4. Missing direct extension mappings force content-based detection
5. Potential auto-detection being triggered despite language being known

## Success Criteria

- [ ] Info.plist (1940 lines) highlights in <500ms on first view
- [ ] Subsequent views of same file load from cache in <50ms
- [ ] Cache persists across QuickLook restarts
- [ ] All Xcode file types (.entitlements, .xcconfig, etc.) handled correctly
- [ ] No regression in existing functionality

## Phases

### Phase P1: Diagnostics & Profiling
**Goal:** Understand exactly where time is spent before making changes
**Depends on:** Nothing
**Estimated plans:** 1

Key tasks:
- Add detailed timing logs to PreviewContentView highlighting flow
- Add logging to confirm which highlighter (Fast vs HighlightSwift) is used
- Profile with Instruments (Time Profiler)
- Document baseline measurements for various file types/sizes
- Identify the actual bottleneck(s)

**Output:** DIAGNOSTICS.md with baseline measurements and bottleneck analysis

### Phase P2: Quick Wins
**Goal:** Low-effort fixes that improve detection and reduce overhead
**Depends on:** P1 (need baseline to measure improvement)
**Estimated plans:** 1

Key tasks:
- Add .plist â†’ xml mapping to LanguageDetector.extensionMap
- Add all missing Xcode UTIs to Info.plist (entitlements, xcconfig, xcscheme, etc.)
- Ensure language is always passed to highlighter (never trigger auto-detection)
- Verify HighlightSwift is using `.languageAlias()` not `.automatic`
- Measure improvement

**Output:** Improved detection, baseline comparison

### Phase P3: Persistent Cache Implementation
**Goal:** Cache highlighted content to disk so it survives XPC termination
**Depends on:** P2
**Estimated plans:** 2

Key tasks:
- Design cache key strategy (file path + modification date + theme hash)
- Implement disk cache using App Groups container
- Archive AttributedString using NSKeyedArchiver
- Implement two-tier cache (memory LRU + disk persistence)
- Add cache size limits and cleanup strategy
- Handle cache invalidation (file modified, theme changed)
- Measure improvement

**Output:** Working persistent cache, files only highlight once

### Phase P4: Highlighter Evaluation & Decision
**Goal:** Determine best highlighting approach through benchmarking
**Depends on:** P3 (cache should be in place for fair comparison)
**Estimated plans:** 2

Key tasks:
- Benchmark FastSyntaxHighlighter vs HighlightSwift vs Highlightr
- Test with standardized file set (small/medium/large, various languages)
- Analyze memory usage, CPU usage, time-to-first-paint
- Document findings with data
- Make decision on primary highlighter
- Implement chosen solution
- Measure improvement

**Output:** Data-driven highlighter decision, implementation

### Phase P5: Advanced Optimizations (if needed)
**Goal:** Additional optimizations if P1-P4 don't meet targets
**Depends on:** P4
**Estimated plans:** 1-3 (conditional)

Potential approaches (evaluate based on P4 results):
- Progressive/chunked rendering (highlight visible portion first)
- WKWebView + HTML approach (offload to WebKit)
- Optimized regex strategy (single-pass highlighting)
- Background pre-warming of common files

**Output:** Meet <500ms target for all files

### Phase P6: Integration & Verification
**Goal:** Ensure everything works together, no regressions
**Depends on:** P4 or P5
**Estimated plans:** 1

Key tasks:
- Full test suite across all supported file types
- Performance verification against success criteria
- Memory usage verification
- UTI verification for Xcode files
- Edge case testing (very large files, binary detection, encoding)

**Output:** Verified, production-ready performance

## Phase Summary

| Phase | Name | Plans | Depends On | Status |
|-------|------|-------|------------|--------|
| P1 | Diagnostics & Profiling | 1 | - | COMPLETE |
| P2 | Quick Wins | 1 | P1 | COMPLETE |
| P3 | Persistent Cache | 2 | P2 | COMPLETE |
| P4 | Highlighter Evaluation | 2 | P3 | IN PROGRESS (1/2) |
| P5 | Advanced Optimizations | 1-3 | P4 | Conditional |
| P6 | Integration & Verification | 1 | P4/P5 | Not started |

**Total estimated plans:** 8-11

## After This Milestone

Once performance targets are met, resume App Store submission milestone:
- Phase 6: App Store Connect Setup
- Phase 7: Metadata & Description
- Phase 8: Privacy & Legal
- ... (remaining phases)

## Research Sources

- [Highlightr](https://github.com/raspu/Highlightr) - 50ms/500 lines benchmark
- [SourceCodeSyntaxHighlight](https://github.com/sbarex/SourceCodeSyntaxHighlight) - WKWebView approach
- [Swift Forums - Regex Performance](https://forums.swift.org/t/performance-of-the-new-regex-in-swift-5-7-degrades-quadratically-without-need/58122)
- [Swift by Sundell - Caching](https://www.swiftbysundell.com/articles/caching-in-swift/)
- [highlight.js optimization](https://medium.com/@hizacharylee/simplify-syntax-highlighting-with-highlight-js-b65af3bdc509)
