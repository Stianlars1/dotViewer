---
phase: 05.1-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - QuickLookPreview/PreviewContentView.swift
  - QuickLookPreview/Info.plist
autonomous: true
---

<objective>
Fix two critical issues blocking App Store submission: slow highlighting for large files and missing Xcode-related UTIs.

Purpose: Large files (50KB+, 1940 lines) take 15+ seconds to preview, making QuickLook unusable. Additionally, .entitlements and other Xcode files fall back to system preview instead of dotViewer.

Output: Fast preview for large files, proper handling of all Xcode-related file types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/CONTEXT-ISSUES.md
@QuickLookPreview/PreviewContentView.swift
@QuickLookPreview/Info.plist
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix performance for large file highlighting</name>
  <files>QuickLookPreview/PreviewContentView.swift</files>
  <action>
Modify the `highlightCode()` function (starting at line 151) with the following changes:

1. **Add file size threshold** (new constant near line 171):
   ```swift
   let maxFileSizeForHighlighting = 30 * 1024 // 30KB
   ```
   Add a check using `state.content.utf8.count` before the line count check. If file exceeds 30KB, skip highlighting and show plain text immediately.

2. **Lower threshold for slow languages** (after the maxLinesForHighlighting check):
   Add language-specific limits for XML, JSON, and plist files since they're slow to parse:
   ```swift
   // XML/JSON/plist are slow to highlight - use stricter limits
   let slowLanguages = ["xml", "json", "plist"]
   if let lang = state.language?.lowercased(), slowLanguages.contains(lang) {
       let maxLinesForSlowLanguage = 500
       if state.lineCount > maxLinesForSlowLanguage {
           withAnimation(.easeIn(duration: 0.15)) {
               isReady = true
           }
           return
       }
   }
   ```

3. **Lower general threshold** from 2000 to 1000 lines (line 171):
   ```swift
   let maxLinesForHighlighting = 1000
   ```

4. **Add early bailout log** for debugging:
   Before each early return in highlighting, add a log line indicating why highlighting was skipped (file size, line count, slow language).

The key insight: the 2-second timeout isn't effective because HighlightSwift's operations don't cooperate with Swift's cancellation. The fix is to NOT START highlighting for large/slow files, rather than trying to cancel mid-operation.

Do NOT modify the timeout logic itself - it's a fallback. The primary fix is preventing expensive operations from starting.
  </action>
  <verify>
Build succeeds: `xcodebuild -scheme dotViewer -configuration Debug build 2>&1 | tail -20`
  </verify>
  <done>
- File size threshold added (30KB)
- Slow language threshold added (500 lines for xml/json/plist)
- General threshold lowered to 1000 lines
- Build passes without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add missing Xcode-related UTIs</name>
  <files>QuickLookPreview/Info.plist</files>
  <action>
Add the following system UTIs to the `QLSupportedContentTypes` array in QuickLookPreview/Info.plist. Place them in the "Apple-Specific" section (after line 133, before "Build Systems"):

```xml
<!-- Xcode Project Files -->
<string>com.apple.xcode.entitlements-property-list</string>
<string>com.apple.xcode.xcconfig</string>
<string>com.apple.xcode.xcscheme</string>
<string>com.apple.xcode.xcworkspacedata</string>
<string>com.apple.xcode.pbxproject</string>
<string>com.apple.xcode.playground</string>
<string>com.apple.dt.playground</string>
```

These are SYSTEM UTIs that macOS assigns to Xcode files. They're different from custom UTIs - the system recognizes these automatically for files like:
- .entitlements → com.apple.xcode.entitlements-property-list
- .xcconfig → com.apple.xcode.xcconfig
- .xcscheme → com.apple.xcode.xcscheme
- .xcworkspacedata → com.apple.xcode.xcworkspacedata
- .pbxproj → com.apple.xcode.pbxproject
- .playground → com.apple.dt.playground / com.apple.xcode.playground

Note: `com.apple.xcode.strings-text` and `com.apple.xcode.plist-text` are already present (lines 128-129). Do not duplicate them.
  </action>
  <verify>
Validate plist syntax: `plutil -lint QuickLookPreview/Info.plist`
  </verify>
  <done>
- All missing Xcode UTIs added to QLSupportedContentTypes
- plist validation passes
  </done>
</task>

<task type="auto">
  <name>Task 3: Rebuild and test</name>
  <files>N/A</files>
  <action>
1. Clean build:
   ```bash
   xcodebuild clean -scheme dotViewer -configuration Debug
   xcodebuild -scheme dotViewer -configuration Debug build
   ```

2. Find the built app:
   ```bash
   find ~/Library/Developer/Xcode/DerivedData -name "dotViewer.app" -type d 2>/dev/null | head -1
   ```

3. Re-register the app with Launch Services:
   ```bash
   /System/Library/Frameworks/CoreServices.framework/Frameworks/LaunchServices.framework/Support/lsregister -f -R <path-to-dotViewer.app>
   ```

4. Kill existing QuickLook daemon to force reload:
   ```bash
   killall QuickLookUIService 2>/dev/null || true
   ```

5. Create a test file to verify .entitlements handling:
   ```bash
   echo '<?xml version="1.0" encoding="UTF-8"?>' > /tmp/test.entitlements
   echo '<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">' >> /tmp/test.entitlements
   echo '<plist version="1.0"><dict><key>test</key><true/></dict></plist>' >> /tmp/test.entitlements
   ```

6. Check the UTI macOS assigns to verify:
   ```bash
   mdls -name kMDItemContentType /tmp/test.entitlements
   ```
   Should output: `com.apple.xcode.entitlements-property-list`
  </action>
  <verify>
- Build completes without errors
- lsregister completes successfully
- mdls shows correct UTI for .entitlements file
  </verify>
  <done>
- Clean build succeeds
- App re-registered with Launch Services
- QuickLook daemon restarted
- Test file created and UTI verified
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `xcodebuild -scheme dotViewer -configuration Debug build` succeeds
- [ ] `plutil -lint QuickLookPreview/Info.plist` passes
- [ ] Performance thresholds implemented (30KB size, 1000 lines general, 500 lines for slow languages)
- [ ] Missing Xcode UTIs added (entitlements, xcconfig, xcscheme, xcworkspacedata, pbxproject)
- [ ] App rebuilt and registered
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No errors or warnings introduced
- Large files (>30KB or >1000 lines) skip highlighting and show plain text immediately
- XML/JSON/plist files >500 lines skip highlighting
- .entitlements and other Xcode files are handled by dotViewer
  </success_criteria>

<output>
After completion, create `.planning/phases/05.1-critical-fixes/05.1-01-SUMMARY.md`
</output>
