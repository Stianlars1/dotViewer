---
phase: 04-app-store-prep
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [dotViewer/dotViewer.entitlements, dotViewer/ExtensionStatusChecker.swift, dotViewer/ContentView.swift]
autonomous: true
---

<objective>
Enable App Sandbox and replace pluginkit-based extension detection with a sandbox-compatible static setup guide.

Purpose: Mac App Store requires sandboxed apps. The current `pluginkit` shell command doesn't work from sandbox. Replace with a static setup guide UI (industry standard for sandboxed apps with extensions).

Output: Sandboxed app ready for App Store submission with user-friendly setup instructions.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

Key files:
@dotViewer/dotViewer.entitlements (currently sandbox disabled)
@dotViewer/ExtensionStatusChecker.swift (uses pluginkit shell command)
@dotViewer/ContentView.swift (StatusView uses ExtensionStatusChecker)
@QuickLookPreview/QuickLookPreview.entitlements (reference - already sandboxed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable App Sandbox in main app entitlements</name>
  <files>dotViewer/dotViewer.entitlements</files>
  <action>
Change `com.apple.security.app-sandbox` from `false` to `true`.

Keep the existing application group entitlement for shared settings.

The entitlements should look like:
```xml
<key>com.apple.security.app-sandbox</key>
<true/>
<key>com.apple.security.application-groups</key>
<array>
    <string>group.stianlars1.dotViewer.shared</string>
</array>
```

Do NOT add any temporary exception entitlements - these will cause App Store rejection.
  </action>
  <verify>plutil -lint dotViewer/dotViewer.entitlements passes</verify>
  <done>App sandbox enabled with only allowed entitlements</done>
</task>

<task type="auto">
  <name>Task 2: Replace ExtensionStatusChecker with static setup guide</name>
  <files>dotViewer/ExtensionStatusChecker.swift, dotViewer/ContentView.swift</files>
  <action>
**ExtensionStatusChecker.swift:**
Remove the pluginkit-based implementation entirely. Replace with a simple class that:
- Has no shell command execution
- Provides a method to open System Settings extensions pane
- Is sandbox-safe

Simplified implementation:
```swift
import SwiftUI
import os.log

private let logger = Logger(subsystem: "com.stianlars1.dotViewer", category: "ExtensionHelper")

/// Helper for extension-related actions (sandbox-compatible)
@MainActor
final class ExtensionHelper: ObservableObject {
    static let shared = ExtensionHelper()

    private init() {}

    /// Opens System Settings to the Extensions pane
    func openExtensionSettings() {
        if let url = URL(string: "x-apple.systempreferences:com.apple.ExtensionsPreferences") {
            NSWorkspace.shared.open(url)
            logger.info("Opened extension settings")
        }
    }
}
```

**ContentView.swift - StatusView:**
Replace the dynamic status checking with a static setup guide:

1. Remove `@StateObject private var checker = ExtensionStatusChecker.shared`
2. Replace with `@StateObject private var helper = ExtensionHelper.shared`
3. Change the Extension Status Card to a Setup Guide that:
   - Always shows setup instructions (no live status)
   - Has a prominent "Open Extension Settings" button
   - Shows numbered steps to enable the extension
   - Removes the refresh button (no longer needed)
   - Removes conditional logic based on isEnabled/isChecking

The new UI should:
- Show a setup icon (e.g., "gearshape.2" or "puzzlepiece.extension")
- Title: "Enable Quick Look Extension"
- Subtitle: "Follow these steps to enable dotViewer"
- Numbered steps:
  1. Click "Open Extension Settings" below
  2. Click "Quick Look" in the sidebar
  3. Enable "dotViewer" checkbox
  4. Try previewing a code file with Space in Finder
- Prominent "Open Extension Settings" button
- Remove the "Quick Stats" section that was conditionally shown (or always show it)

4. Remove the onReceive notification handler for didBecomeActiveNotification (no longer needed)
5. Keep the "How to Use" section as-is
  </action>
  <verify>Build succeeds: xcodebuild -scheme dotViewer -configuration Debug build 2>&1 | grep -E "(error:|BUILD SUCCEEDED|BUILD FAILED)"</verify>
  <done>ExtensionStatusChecker removed, StatusView shows static setup guide</done>
</task>

<task type="auto">
  <name>Task 3: Verify sandbox compliance and test build</name>
  <files>dotViewer/dotViewer.entitlements</files>
  <action>
1. Run full build to verify no sandbox violations in code:
   ```
   xcodebuild -scheme dotViewer -configuration Release build
   ```

2. Verify entitlements in built app:
   ```
   codesign -d --entitlements - "build/Release/dotViewer.app" 2>&1 | grep -A 20 "Executable="
   ```

   Should show:
   - com.apple.security.app-sandbox = true
   - com.apple.security.application-groups with the group ID
   - NO temporary-exception entitlements

3. Verify the app launches without sandbox violations:
   - Check Console.app for any sandbox denial messages
   - Filter by "com.stianlars1.dotViewer" and "sandbox"

If any sandbox violations are found, fix them before completing.
  </action>
  <verify>xcodebuild build succeeds AND codesign shows only sandbox + app-groups entitlements</verify>
  <done>App builds and runs with sandbox enabled, no temporary exceptions</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] plutil -lint passes for dotViewer.entitlements
- [ ] xcodebuild -scheme dotViewer build succeeds
- [ ] App launches without crash
- [ ] Status view shows setup guide (not live status)
- [ ] "Open Extension Settings" button works
- [ ] No sandbox violation errors in Console.app
- [ ] codesign shows sandbox enabled, no temporary exceptions
</verification>

<success_criteria>
- App Sandbox enabled (com.apple.security.app-sandbox: true)
- No pluginkit or other shell commands in codebase
- StatusView shows static setup guide
- Build succeeds without errors
- App runs in sandbox without violations
</success_criteria>

<output>
After completion, create `.planning/phases/04-app-store-prep/04-01-SUMMARY.md`
</output>
