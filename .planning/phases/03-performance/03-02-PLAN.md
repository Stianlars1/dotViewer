---
phase: 03-performance
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [syntect-swift/build-xcframework.sh, dotViewer.xcodeproj/project.pbxproj]
autonomous: true
---

<objective>
Build XCFramework from Rust library and add to Xcode project.

Purpose: Generate Swift bindings and universal binary framework that can be imported into the macOS app.
Output: SyntectSwift.xcframework added to Xcode project, ready for use.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance/03-01-SUMMARY.md

@syntect-swift/Cargo.toml
@syntect-swift/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Rust toolchain and targets</name>
  <files>None (system setup)</files>
  <action>
Ensure Rust toolchain is installed with required targets:

```bash
# Check if rustup is installed
which rustup || curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh

# Add macOS targets (Intel and Apple Silicon)
rustup target add x86_64-apple-darwin
rustup target add aarch64-apple-darwin

# Install uniffi-bindgen-cli
cargo install uniffi-bindgen-cli
```

Verify installation:
```bash
rustc --version
cargo --version
uniffi-bindgen --version
```
  </action>
  <verify>All commands succeed without errors</verify>
  <done>Rust toolchain ready with macOS targets</done>
</task>

<task type="auto">
  <name>Task 2: Create build script for XCFramework</name>
  <files>syntect-swift/build-xcframework.sh</files>
  <action>
Create a build script that:
1. Builds for both x86_64-apple-darwin and aarch64-apple-darwin
2. Generates Swift bindings using uniffi-bindgen
3. Creates universal binary using lipo
4. Packages into XCFramework

```bash
#!/bin/bash
set -e

cd "$(dirname "$0")"

# Build for both architectures
echo "Building for x86_64..."
cargo build --release --target x86_64-apple-darwin

echo "Building for aarch64..."
cargo build --release --target aarch64-apple-darwin

# Generate Swift bindings
echo "Generating Swift bindings..."
uniffi-bindgen generate \
    --library target/aarch64-apple-darwin/release/libsyntect_swift.dylib \
    --language swift \
    --out-dir ./generated

# Create universal binary
echo "Creating universal binary..."
mkdir -p target/universal/release
lipo -create \
    target/x86_64-apple-darwin/release/libsyntect_swift.a \
    target/aarch64-apple-darwin/release/libsyntect_swift.a \
    -output target/universal/release/libsyntect_swift.a

# Create module.modulemap
cat > generated/module.modulemap << 'EOF'
framework module SyntectSwift {
    umbrella header "syntect_swiftFFI.h"
    export *
    module * { export * }
}
EOF

# Create XCFramework
echo "Creating XCFramework..."
rm -rf SyntectSwift.xcframework
xcodebuild -create-xcframework \
    -library target/universal/release/libsyntect_swift.a \
    -headers generated/ \
    -output SyntectSwift.xcframework

echo "Done! XCFramework created at syntect-swift/SyntectSwift.xcframework"
```

Make executable: `chmod +x build-xcframework.sh`
  </action>
  <verify>Script file exists and is executable</verify>
  <done>Build script created</done>
</task>

<task type="auto">
  <name>Task 3: Build XCFramework and add to Xcode project</name>
  <files>dotViewer.xcodeproj/project.pbxproj</files>
  <action>
1. Run the build script:
```bash
cd syntect-swift && ./build-xcframework.sh
```

2. Copy generated Swift file to Shared:
```bash
cp syntect-swift/generated/syntect_swift.swift Shared/SyntectBridge.swift
```

3. Add to Xcode project:
   - Drag SyntectSwift.xcframework into Xcode project
   - Add to both dotViewer and QuickLookPreview targets
   - Ensure "Embed & Sign" for the framework
   - Add SyntectBridge.swift to Shared folder in Xcode

4. Verify build:
```bash
xcodebuild -project dotViewer.xcodeproj -scheme dotViewer build
```
  </action>
  <verify>
```bash
xcodebuild -project dotViewer.xcodeproj -scheme dotViewer build 2>&1 | grep -E "(BUILD SUCCEEDED|error:)"
```
Build succeeds.
  </verify>
  <done>XCFramework integrated into Xcode project</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] XCFramework exists at syntect-swift/SyntectSwift.xcframework
- [ ] Generated Swift bindings compile
- [ ] Xcode project builds successfully
- [ ] Framework linked to both main app and QuickLook extension
</verification>

<success_criteria>
- XCFramework created with universal binary
- Swift bindings generated and added to project
- Both targets (dotViewer, QuickLookPreview) build successfully
- No linker errors
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance/03-02-SUMMARY.md`
</output>
