---
phase: 03-performance
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified: [QuickLookPreview/PreviewContentView.swift]
autonomous: true
---

<objective>
Implement instant preview with progressive enhancement - show plain text immediately, then apply syntax highlighting asynchronously.

Purpose: Users see content instantly (<100ms) instead of waiting 1-2s for highlighting to complete.
Output: Preview displays plain text immediately, highlighting fades in when ready.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-performance/03-01-SUMMARY.md

@QuickLookPreview/PreviewContentView.swift
@QuickLookPreview/PreviewViewController.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement instant plain text display with progressive highlighting</name>
  <files>QuickLookPreview/PreviewContentView.swift</files>
  <action>
Modify PreviewContentView to show content immediately:

1. Change `isReady` initialization to `true` (show content immediately)
2. Add new state `@State private var isHighlighting = false` to track highlighting progress
3. Display plain text content initially (using existing `plainContent` in CodeContentView)
4. Start highlighting in background task
5. When highlighting completes, swap in highlighted content with subtle fade

The CodeContentView already accepts both plainContent and highlightedContent - it uses highlightedContent if available, falls back to plainContent. This means we just need to:
- Set `isReady = true` immediately
- Let the existing `highlightCode()` task run and update `highlightedContent` when done

Current behavior shows loading spinner while highlighting. New behavior shows plain text immediately.

Key changes:
```swift
// In body, remove the !isReady loading indicator branch entirely
// OR change to only show a subtle "highlighting..." indicator

// In init or body:
// Start with isReady = true so content shows immediately

// highlightCode() already updates highlightedContent async - no changes needed there
```

Keep the loading spinner ONLY for cached content lookup (which is instant) or very large files.
  </action>
  <verify>
1. Build succeeds: `xcodebuild -project dotViewer.xcodeproj -scheme QuickLookPreview build`
2. Manual test: Preview a Swift file - should show plain text instantly, colors appear after ~1s
  </verify>
  <done>Plain text displays instantly, highlighting applies progressively</done>
</task>

<task type="auto">
  <name>Task 2: Add subtle highlighting-in-progress indicator</name>
  <files>QuickLookPreview/PreviewContentView.swift</files>
  <action>
Add a non-blocking indicator that highlighting is in progress:

1. Add small progress indicator in header area (not blocking content)
2. Show only while `highlightedContent == nil && state.language != nil`
3. Hide when highlighting completes or times out

Options (choose simplest):
- Small spinner in header next to language badge
- Subtle "Highlighting..." text that fades out when done
- Progress bar at top of content area

Keep it minimal - the goal is to show users something is happening without blocking content viewing. If highlighting times out (existing 2s timeout), indicator should hide.
  </action>
  <verify>Build succeeds and indicator shows briefly during highlighting</verify>
  <done>Non-blocking progress indicator shows during highlighting</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] Preview shows plain text within 100ms of pressing Space
- [ ] Syntax highlighting applies progressively (fade in)
- [ ] No blocking spinner for normal files
- [ ] Timeout behavior unchanged (2s max for highlighting)
</verification>

<success_criteria>
- Plain text visible instantly on preview open
- Highlighting applies asynchronously without blocking
- Subtle indicator shows highlighting is in progress
- User experience improved from "wait 1-2s" to "instant with progressive enhancement"
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance/03-02-SUMMARY.md`
</output>
