---
phase: 03-performance
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified: [Shared/SyntaxHighlighter.swift, QuickLookPreview/PreviewContentView.swift]
autonomous: false
---

<objective>
Replace HighlightSwift with Syntect-based highlighter and validate performance.

Purpose: Integrate the new fast Syntect highlighter into the app, replacing the slow JavaScriptCore-based HighlightSwift.
Output: Syntax highlighting using native Syntect, with verified performance meeting 140 BPM requirement.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
@~/.claude/get-shit-done/references/checkpoints.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-performance/03-01-SUMMARY.md
@.planning/phases/03-performance/03-02-SUMMARY.md

@Shared/SyntaxHighlighter.swift
@Shared/SyntectBridge.swift
@QuickLookPreview/PreviewContentView.swift
@Shared/ThemeManager.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create new SyntaxHighlighter using Syntect</name>
  <files>Shared/SyntaxHighlighter.swift</files>
  <action>
Replace the current HighlightSwift-based implementation with Syntect:

```swift
import Foundation
import SwiftUI

actor SyntaxHighlighter {
    static let shared = SyntaxHighlighter()

    private init() {}

    /// Highlight code using Syntect (Rust-based, fast)
    func highlight(code: String, language: String?, theme: String = "github-dark") async throws -> AttributedString {
        // Map language name to Syntect language identifier
        let syntectLanguage = mapLanguage(language)
        let syntectTheme = mapTheme(theme)

        // Call Syntect via UniFFI bindings
        let result = highlightCode(code, syntectLanguage, syntectTheme)

        // Convert HighlightResult spans to AttributedString
        return convertToAttributedString(result)
    }

    private func mapLanguage(_ language: String?) -> String {
        guard let lang = language else { return "Plain Text" }
        // Map dotViewer language names to Syntect names
        let mapping: [String: String] = [
            "bash": "Bourne Again Shell (bash)",
            "javascript": "JavaScript",
            "typescript": "TypeScript",
            "swift": "Swift",
            "python": "Python",
            "json": "JSON",
            "yaml": "YAML",
            "markdown": "Markdown",
            // ... add all mappings
        ]
        return mapping[lang.lowercased()] ?? lang
    }

    private func mapTheme(_ theme: String) -> String {
        // Map app themes to Syntect theme names
        let mapping: [String: String] = [
            "github-dark": "base16-ocean.dark",
            "monokai": "Monokai Extended",
            // ... add all mappings
        ]
        return mapping[theme] ?? "base16-ocean.dark"
    }

    private func convertToAttributedString(_ result: HighlightResult) -> AttributedString {
        var attributedString = AttributedString()

        for span in result.spans {
            var attrs = AttributeContainer()

            // Parse hex color to SwiftUI Color
            if let color = Color(hex: span.foreground) {
                attrs.foregroundColor = color
            }

            // Apply font style
            if span.fontStyle & 1 != 0 { // bold
                attrs.font = .system(.body).bold()
            }
            if span.fontStyle & 2 != 0 { // italic
                attrs.font = .system(.body).italic()
            }

            var spanAttr = AttributedString(span.text)
            spanAttr.mergeAttributes(attrs)
            attributedString.append(spanAttr)
        }

        return attributedString
    }
}

// Helper extension for hex color parsing
extension Color {
    init?(hex: String) {
        // Parse "#RRGGBB" format
        // ... implementation
    }
}
```

Keep the async interface for API compatibility with existing callers.
  </action>
  <verify>
```bash
xcodebuild -project dotViewer.xcodeproj -scheme dotViewer build
```
Build succeeds.
  </verify>
  <done>New SyntaxHighlighter implemented using Syntect</done>
</task>

<task type="auto">
  <name>Task 2: Update PreviewContentView to use new highlighter</name>
  <files>QuickLookPreview/PreviewContentView.swift</files>
  <action>
Update the highlightCode() function in PreviewContentView:

1. Remove HighlightSwift import
2. Use the new SyntaxHighlighter.shared
3. Add timing instrumentation to measure performance:

```swift
private func highlightCode() async {
    let startTime = CFAbsoluteTimeGetCurrent()

    do {
        let highlighted = try await SyntaxHighlighter.shared.highlight(
            code: state.content,
            language: state.language,
            theme: themeManager.currentTheme
        )

        let elapsed = CFAbsoluteTimeGetCurrent() - startTime
        logger.info("Highlighted \(state.content.count) chars in \(elapsed * 1000, format: .fixed(precision: 1))ms")

        await MainActor.run {
            self.highlightedContent = highlighted
        }
    } catch {
        logger.error("Highlighting failed: \(error)")
    }
}
```

4. Remove HighlightSwift from Package.swift dependencies
  </action>
  <verify>Build QuickLookPreview extension: `xcodebuild -project dotViewer.xcodeproj -scheme QuickLookPreview build`</verify>
  <done>PreviewContentView updated to use Syntect highlighter</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Syntect-based syntax highlighting replacing HighlightSwift</what-built>
  <how-to-verify>
1. Build and install: `xcodebuild -project dotViewer.xcodeproj -scheme dotViewer build`
2. Install the extension (run the app once, enable in System Settings > Extensions)
3. Open Console.app, filter for "dotViewer"
4. Navigate to a folder with source files (e.g., this project's Shared/ folder)
5. Press Space on various files and watch Console for timing:
   - .swift files
   - .json files
   - .md files
   - .sh or config files

**Performance target**: Each file should highlight in <100ms (ideally <50ms)

6. Rapid navigation test:
   - Select a file, press Space
   - Use arrow keys to navigate up/down through 10+ files rapidly
   - Observe: Does highlighting keep up? Any lag?

**Target**: Smooth at 140 BPM (~430ms between files)
  </how-to-verify>
  <resume-signal>
Report timing results and whether performance meets requirements:
- "approved" - Performance is good, proceed
- "too slow" - Need to investigate, may need fallback
- Describe any issues observed
  </resume-signal>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] HighlightSwift dependency removed
- [ ] Syntect highlighter integrated
- [ ] Timing logs show <100ms per file
- [ ] Rapid navigation test passes
- [ ] All common languages highlight correctly
</verification>

<success_criteria>
- Syntax highlighting works for all supported languages
- Performance: <100ms for typical files
- Rapid navigation at 140 BPM feels instant
- No visual regressions in highlighting quality
</success_criteria>

<output>
After completion, create `.planning/phases/03-performance/03-03-SUMMARY.md`
</output>
